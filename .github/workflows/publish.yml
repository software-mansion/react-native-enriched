name: Publish
on:
  workflow_dispatch:
    inputs:
      dryRun:
        description: 'Set to true to perform a dry run'
        required: false
        default: 'true'

permissions:
  id-token: write
  contents: read

jobs:
  verify-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run ESLint (JS/TS check)
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

      - name: Run clang-format (C/C++ check)
        run: yarn lint-clang

      - name: Run android lint (Kotlin/Java/Groovy check)
        run: yarn lint:android

      - name: Run unit tests
        run: yarn test --maxWorkers=2 --coverage

      - name: Build package
        run: |
          # npm pack outputs the filename of the created tarball to stdout
          PACK_NAME=$(npm pack)
          echo "PACKAGE_PATH=$PACK_NAME" >> $GITHUB_ENV
          echo "Generated package: $PACK_NAME"

      - name: Upload NPM tarball as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_PATH }}
          path: ${{ env.PACKAGE_PATH }}
          overwrite: true
          if-no-files-found: error

      - name: Publish package (dry-run)
        if: ${{ github.event.inputs.dryRun == 'true' }}
        run: |
          echo "Dry run enabled â€” skipping actual publish"
#          npm publish --dry-run

      - name: Publish package
        if: ${{ github.event.inputs.dryRun != 'true' }}
#        run: npm publish
        run: echo "Publishing package..."
